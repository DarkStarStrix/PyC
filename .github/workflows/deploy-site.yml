name: Deploy Site

on:
  push:
    branches: ["main"]
    paths:
      - "index.html"
      - "styles.css"
      - "app.js"
      - "inference-site/**"
      - "website/results/**"
      - "benchmark/benchmarks/results/**"
      - "docs/compiler-next/**"
      - ".github/workflows/deploy-site.yml"
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare site artifact
        run: |
          mkdir -p site
          touch site/.nojekyll
          cp index.html styles.css app.js site/
          cp -R inference-site site/inference-site

          mkdir -p site/website
          cp -R website/results site/website/results

          mkdir -p site/benchmark/benchmarks
          cp -R benchmark/benchmarks/results site/benchmark/benchmarks/results

          mkdir -p site/docs
          cp -R docs/compiler-next site/docs/compiler-next

      - name: Remove stale Pages artifacts from this run
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const run_id = context.runId;
            const artifactName = "github-pages";
            const artifacts = await github.paginate(
              github.rest.actions.listWorkflowRunArtifacts,
              { owner, repo, run_id, name: artifactName, per_page: 100 }
            );
            for (const artifact of artifacts) {
              core.info(`Deleting stale artifact ${artifact.name} (id=${artifact.id})`);
              await github.rest.actions.deleteArtifact({
                owner,
                repo,
                artifact_id: artifact.id,
              });
            }

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
